<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gate Pass Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2.5rem 0; margin-bottom: 2rem; border-radius: 0 0 20px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .form-card { border: none; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
    .item-row { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    .btn-download { padding: 12px 50px; font-size: 1.1rem; border-radius: 50px; }
  </style>
</head>
<body>
  <div class="page-header text-center">
    <div class="container">
      <h1 class="display-4 fw-bold">Gate Pass Details</h1>
      <p class="lead">View details and download as PDF</p>
    </div>
  </div>
  <div class="container mb-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card form-card">
          <div class="card-body p-5">
            <!-- Gate Pass ID and Dates -->
            <div class="mb-4">
              <label class="form-label fw-bold">Gate Pass ID</label>
              <p class="form-control"><%= gatepass._id %></p>
            </div>
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold">Dispatch Date</label>
                <p class="form-control"><%= new Date(gatepass.date).toLocaleDateString('en-GB') %></p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">Created At</label>
                <p class="form-control"><%= new Date(gatepass.createdAt).toLocaleDateString('en-GB') %></p>
              </div>
            </div>
            <!-- Dispatch From -->
            <div class="mb-4">
              <label class="form-label fw-bold">Dispatch From</label>
              <p class="form-control"><%= gatepass.dispatchFrom?.hubName || 'N/A' %> - <%= gatepass.dispatchFrom?.details || 'N/A' %></p>
            </div>
            <!-- Dispatch To -->
            <div class="mb-4">
              <label class="form-label fw-bold">Dispatch To</label>
              <p class="form-control"><%= gatepass.dispatchTo?.hubName || 'N/A' %> - <%= gatepass.dispatchTo?.details || 'N/A' %></p>
            </div>
            <!-- Sender -->
            <div class="mb-4">
              <h5 class="fw-bold text-primary mb-3">Sender's Details</h5>
              <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Name</label><p class="form-control"><%= gatepass.sender?.name || 'N/A' %></p></div>
                <div class="col-md-6"><label class="form-label">Phone</label><p class="form-control"><%= gatepass.sender?.phone || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Designation</label><p class="form-control"><%= gatepass.sender?.designation || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Employee ID</label><p class="form-control"><%= gatepass.sender?.employee_id || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Department</label><p class="form-control"><%= gatepass.sender?.department || 'N/A' %></p></div>
              </div>
            </div>
            <!-- Receiver -->
            <div class="mb-4">
              <h5 class="fw-bold text-primary mb-3">Receiver's Details</h5>
              <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Name</label><p class="form-control"><%= gatepass.receiver?.name || 'N/A' %></p></div>
                <div class="col-md-6"><label class="form-label">Phone</label><p class="form-control"><%= gatepass.receiver?.phone || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Designation</label><p class="form-control"><%= gatepass.receiver?.designation || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Employee ID</label><p class="form-control"><%= gatepass.receiver?.employee_id || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Department</label><p class="form-control"><%= gatepass.receiver?.department || 'N/A' %></p></div>
              </div>
            </div>
            <!-- Prepared By -->
            <div class="mb-4">
              <h5 class="fw-bold text-primary mb-3">Prepared By</h5>
              <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Name</label><p class="form-control"><%= gatepass.preparedBy?.name || 'N/A' %></p></div>
                <div class="col-md-6"><label class="form-label">Phone</label><p class="form-control"><%= gatepass.preparedBy?.phone || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Designation</label><p class="form-control"><%= gatepass.preparedBy?.designation || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Employee ID</label><p class="form-control"><%= gatepass.preparedBy?.employee_id || 'N/A' %></p></div>
                <div class="col-md-4"><label class="form-label">Department</label><p class="form-control"><%= gatepass.preparedBy?.department || 'N/A' %></p></div>
              </div>
            </div>
            <!-- Items -->
            <div class="mb-4">
              <h5 class="fw-bold text-primary mb-3">Items</h5>
              <div id="items-container">
                <% (gatepass.items || []).forEach((item, index) => { %>
                  <div class="item-row">
                    <div class="row g-3">
                      <div class="col-md-5"><label class="form-label">Item Name</label><p class="form-control"><%= item.name %></p></div>
                      <div class="col-md-2"><label class="form-label">Qty</label><p class="form-control"><%= item.quantity %></p></div>
                      <div class="col-md-2"><label class="form-label">Unit</label><p class="form-control"><%= item.unit %></p></div>
                      <div class="col-md-3"><label class="form-label">Comments</label><p class="form-control"><%= item.comments || 'N/A' %></p></div>
                    </div>
                  </div>
                <% }) %>
              </div>
            </div>
            <!-- Remarks -->
            <div class="mb-4">
              <label class="form-label fw-bold">Remarks</label>
              <textarea class="form-control" rows="5" readonly><%= gatepass.remarks || 'N/A' %></textarea>
            </div>
            <div class="text-center">
              <button id="downloadPdfBtn" class="btn btn-primary btn-lg btn-download shadow-lg">Download PDF</button>
              <a href="/api/v1/gatepass" class="btn btn-secondary btn-lg ms-3">Back</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const gatepass = <%- JSON.stringify(gatepass || {}) %>;

      document.getElementById('downloadPdfBtn').addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.width;
        const margin = 10;
        let y = 15;

        // === LOGO + GATE PASS ID ===
        doc.addImage('https://i.ibb.co.com/Df3S8Zhx/daraz-logo.png', 'PNG', margin, y, 30, 8);
        const gatePassId = `GATE PASS#: ${gatepass._id ? 'BD-IT' + new Date(gatepass.createdAt).toISOString().replace(/[-T:.]/g, '').slice(0,14) : 'N/A'}`;
        doc.setFontSize(12);
        doc.text(gatePassId, pageWidth - margin, y + 4, { align: 'right' });
        y += 15;

        // === COMPANY NAME ===
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text('Daraz Bangladesh Limited', pageWidth / 2, y, { align: 'center' });
        y += 10;

        // === DATES ===
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        const dispatchDate = `Dispatch Date: ${gatepass.date ? new Date(gatepass.date).toLocaleDateString('en-GB') : '____/____/____'}`;
        doc.text(dispatchDate, margin, y);
        doc.text('Receiving Date: _____________________', pageWidth - 100, y);
        y += 10;

        doc.text('Challan Type: Internal/External', pageWidth / 2, y, { align: 'center' });
        y += 12;

        // === DISPATCH FROM & TO ===
        doc.autoTable({
          startY: y,
          head: [['Dispatch From', 'Dispatch To']],
          body: [[
            `Name: ${gatepass.dispatchFrom?.hubName || 'N/A'}\nZone: ${gatepass.dispatchFrom?.hubName || 'N/A'}\nAddress: ${gatepass.dispatchFrom?.details || 'N/A'}`,
            `Name: ${gatepass.dispatchTo?.hubName || 'N/A'}\nZone: ${gatepass.dispatchTo?.hubName || 'N/A'}\nAddress: ${gatepass.dispatchTo?.details || 'N/A'}`
          ]],
          theme: 'grid',
          headStyles: { fillColor: [220, 220, 220] },
          styles: { fontSize: 10, cellPadding: 3 }
        });
        y = doc.lastAutoTable.finalY + 8;

        // === SENDER & RECEIVER ===
        doc.autoTable({
          startY: y,
          head: [`Sender's Details`, `Receiver's Details`],
          body: [[
            `Name: ${gatepass.sender?.name || 'N/A'}\nPhone No: ${gatepass.sender?.phone || 'N/A'}\nDesignation: ${gatepass.sender?.designation || 'N/A'}\nEmployee ID: ${gatepass.sender?.employee_id || 'N/A'}\nDepartment: ${gatepass.sender?.department || 'N/A'}`,
            `Name: ${gatepass.receiver?.name || 'N/A'}\nPhone No: ${gatepass.receiver?.phone || 'N/A'}\nDesignation: ${gatepass.receiver?.designation || 'N/A'}\nEmployee ID: ${gatepass.receiver?.employee_id || 'N/A'}\nDepartment: ${gatepass.receiver?.department || 'N/A'}`
          ]],
          theme: 'grid',
          headStyles: { fillColor: [220, 220, 220] },
          styles: { fontSize: 10, cellPadding: 3 }
        });
        y = doc.lastAutoTable.finalY + 8;

        // === ITEMS TABLE ===
        const items = (gatepass.items || []).map((item, i) => [
          i + 1,
          item.name || '',
          item.quantity || '',
          item.unit || ''
        ]);
        while (items.length < 5) items.push([items.length + 1, '', '', '']);

        doc.autoTable({
          startY: y,
          head: [['SL NO', 'ITEM DESCRIPTION', 'QUANTITY', 'UNIT']],
          body: items,
          theme: 'grid',
          headStyles: { fillColor: [220, 220, 220] },
          styles: { fontSize: 10, cellPadding: 2 }
        });
        y = doc.lastAutoTable.finalY + 8;

        // === REMARKS ===
        doc.text('Remarks', margin, y);
        y += 6;
        doc.setDrawColor(0);
        doc.rect(margin, y, pageWidth - 2 * margin, 25);
        if (gatepass.remarks) {
          const split = doc.splitTextToSize(gatepass.remarks, pageWidth - 2 * margin - 4);
          doc.text(split, margin + 2, y + 4);
        }
        y += 32;

        // === Bearer & Recipient ===
        doc.autoTable({
          startY: y,
          head: [`Bearer Details`, `Recipient Details`],
          body: [[
            'Name: _________________________\nPhone No: _________________________',
            `Name: _________________________\nPhone No: ${gatepass.receiver?.phone || 'N/A'}`
          ]],
          theme: 'grid',
          headStyles: { fillColor: [220, 220, 220] },
          styles: { fontSize: 10, cellPadding: 3 }
        });
        y = doc.lastAutoTable.finalY + 8;

        // === PREPARED BY ===
        const pb = gatepass.preparedBy || {};
        doc.autoTable({
          startY: y,
          head: ['Prepared By'],
          body: [[
            `Name: ${pb.name || 'N/A'}\nDesignation: ${pb.designation || 'N/A'}\nEmployee ID: ${pb.employee_id || 'N/A'}\nSign: ${(pb.name || '').toLowerCase()}`
          ]],
          theme: 'grid',
          headStyles: { fillColor: [220, 220, 220] },
          styles: { fontSize: 10, cellPadding: 3 }
        });
        y = doc.lastAutoTable.finalY + 10;

        // === SIGNATURE BLOCKS ===
        doc.autoTable({
          startY: y,
          tableWidth: pageWidth - 2 * margin,
          margin: { left: margin },
          head: [['PREPARED BY', 'SECURITY CHECK', 'RECEIVED BY']],
          body: [['', '', '']],
          theme: 'grid',
          headStyles: { fillColor: [240, 240, 240], textColor: [0,0,0] },
          bodyStyles: { minCellHeight: 15 },
          styles: { fontSize: 10, cellPadding: 4 }
        });
        y = doc.lastAutoTable.finalY;

        doc.autoTable({
          startY: y,
          tableWidth: pageWidth - 2 * margin,
          margin: { left: margin },
          head: [['BEARER SIGNATURE', 'AUTHORISED SIGNATURE']],
          body: [['', '']],
          theme: 'grid',
          headStyles: { fillColor: [240, 240, 240], textColor: [0,0,0] },
          styles: { fontSize: 10, cellPadding: 4 }
        });

        // === FOOTER ===
        doc.setFontSize(9);
        doc.text('Daraz Internal B2 DR-COMP-FRM-GPFRM  28 October, 2024  Version 1.1', pageWidth / 2, 287, { align: 'center' });

        doc.save(`GatePass_${gatepass._id || Date.now()}.pdf`);
      });
    });
  </script>
</body>
</html>